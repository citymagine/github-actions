# .github/workflows/action-front-deploy.yml
name: Deploy
on:
  workflow_call:
    inputs:
      release-tag:
        description: docker tag of the release to deploy
        type: string
        required: false
      environment:
        description: "Which environment would you like to deploy on ?"
        required: true
        type: string
      appname:
        description: "Name of the app. Used in URL"
        type: string
        required: true

jobs:
  deployment:
    runs-on: 'ubuntu-latest'
    steps:
      - uses: actions/checkout@v1
      - name: 'Deploy on dev'
        uses: glopezep/helm@v1.7.1
        if: inputs.environment == 'dev'
        with:
          release: '${{inputs.appname}}'
          namespace: '${{inputs.environment}}'
          chart: './deployment/helm'
          token: '${{ github.token }}'
          value-files: "./deployment/helm/values.yaml"
          version: ${{ inputs.release-tag }}
          values: |
            {
                "image": {
                    "tag": "${{ inputs.release-tag }}"
                },
                ${{secrets.DEV_VALUES}}
            }
          helm: "helm3"
        env:
          KUBECONFIG_FILE: '${{ secrets.KUBECONFIG }}'
      - name: 'Deploy on devAws'
        uses: peymanmortazavi/eks-helm-deploy@v2.2.1
        if: inputs.environment == 'devAws'
        with:
          name: '${{inputs.appname}}'
          namespace: dev
          aws-access-key-id: ${{ secrets.AWS_ACCESS__KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-3
          cluster-name: sandbox2
          chart-path: "deployment/helm/"
          config-files: "./deployment/helm/values.yaml"
          values: image.tag=${{ inputs.release-tag }},${{secrets.DEV_AWS_VALUES}}
      - name: 'Deploy on prod'
        uses: glopezep/helm@v1.7.1
        if: inputs.environment == 'prod'
        with:
          release: '${{inputs.appname}}'
          namespace: '${{inputs.environment}}'
          chart: './deployment/helm'
          token: '${{ github.token }}'
          value-files: "./deployment/helm/values.yaml"
          version: ${{ inputs.release-tag }}
          values: |
            {
                "image": {
                    "tag": "${{ inputs.release-tag }}"
                },
                ${{secrets.PROD_VALUES}}
                }
            }
          helm: "helm3"
        env:
          KUBECONFIG_FILE: '${{ secrets.KUBECONFIG_PROD }}'
